# SCX Prefill é˜¶æ®µ GPU æ“ä½œåˆ†æ

## ğŸ” æ ¸å¿ƒå‘ç°

SCX åœ¨ prefill é˜¶æ®µå¯¹ **GPU ä¸Šçš„æ“ä½œè¿›è¡Œäº†ç²¾å¿ƒè®¾è®¡çš„ç½®æ¢**ï¼Œä¸»è¦ä½“ç°åœ¨ï¼š

1. **Attention å±‚**: åœ¨ hidden_dim ç»´åº¦ä¸Šç½®æ¢
2. **MLP å±‚**: **æ²¡æœ‰åœ¨ GPU ä¸Šåšç½®æ¢**ï¼ˆåªåœ¨ CPU ä¸Šåšåºåˆ—ç½®æ¢ï¼‰

## ğŸ“Š è¯¦ç»†æµç¨‹åˆ†æ

### 1ï¸âƒ£ Attention å±‚ (SCXLlamaAttention)

#### GPU æ“ä½œçš„ç½®æ¢

**ç¬¬ 236-238 è¡Œ - å…³é”®æ“ä½œ**:
```python
if prefill:
    # åœ¨ GPU ä¸Šï¼Œå¯¹ hidden_dim ç»´åº¦åšç½®æ¢
    query_states = query_states[:, :, :, self.attn_pi_right].to(orig_device)
    key_states = key_states[:, :, :, self.attn_pi_right].to(orig_device)
    value_states = value_states[:, :, :, self.attn_pi_right].to(orig_device)
```

**ç»´åº¦è¯´æ˜**:
- `query_states` å½¢çŠ¶: `(batch, num_heads, seq_len, head_dim)`
- `[:, :, :, self.attn_pi_right]` åœ¨ **æœ€åä¸€ä¸ªç»´åº¦ï¼ˆhead_dimï¼‰** ä¸Šç½®æ¢

**è¿™æ„å‘³ç€**:
- âœ… **åœ¨ GPU ä¸Šè®¡ç®— attention** æ—¶ï¼ŒQ/K/V çš„ hidden_dim å·²ç»è¢«ç½®æ¢
- âœ… Attention è®¡ç®— `QK^T` å’Œ `Attention @ V` éƒ½åœ¨**ç½®æ¢åçš„ç©ºé—´**è¿›è¡Œ
- ğŸ”‘ è¿™æ˜¯ **GPU å±‚é¢çš„ç»´åº¦ç½®æ¢é˜²å¾¡**

#### å®Œæ•´çš„ Attention æµç¨‹

```
è¾“å…¥ hidden_states (GPU)
    â†“
ç§»åˆ° CPUï¼Œåšåºåˆ—ç½®æ¢ (ç¬¬ 150-155 è¡Œ)
    â†“
å›åˆ° GPUï¼Œè®¡ç®— Q/K/V projection (ç¬¬ 165-167 è¡Œ)
    â†“
ç§»åˆ° CPUï¼Œæ¢å¤åºåˆ—é¡ºåºï¼Œåš RoPE (ç¬¬ 171-200 è¡Œ)
    â†“
åœ¨ CPU ä¸Šæ›´æ–° KV Cache (ç¬¬ 207-212 è¡Œ)
    â†“
ç§»åˆ° GPUï¼Œå¯¹ Q/K/V åšç»´åº¦ç½®æ¢ (ç¬¬ 236-238 è¡Œ) â­ å…³é”®
    â†“
åœ¨ GPU ä¸Šè®¡ç®— Attention (ç¬¬ 250-259 è¡Œ) â­ åœ¨ç½®æ¢ç©ºé—´
    â†“
ç§»åˆ° CPUï¼Œæ¢å¤ç»´åº¦é¡ºåºï¼Œåšåºåˆ—ç½®æ¢ (ç¬¬ 262-263 è¡Œ)
    â†“
å›åˆ° GPUï¼Œè®¡ç®— o_proj (ç¬¬ 270-271 è¡Œ)
    â†“
ç§»åˆ° CPUï¼Œæ¢å¤åºåˆ—é¡ºåº (ç¬¬ 274-275 è¡Œ)
```

---

### 2ï¸âƒ£ MLP å±‚ (SCXLlamaDecoderLayer)

#### GPU æ“ä½œï¼š**æ— ç½®æ¢**ï¼

**ç¬¬ 83-85 è¡Œ**:
```python
# Fully Connected (åœ¨ GPU ä¸Š)
residual = hidden_states
hidden_states = self.post_attention_layernorm(hidden_states)
hidden_states = self.mlp(hidden_states)
hidden_states = residual + hidden_states
```

**å…³é”®å‘ç°**:
- âŒ **MLP è®¡ç®—åœ¨ GPU ä¸Šæ—¶ï¼Œæ²¡æœ‰åšä»»ä½•ç½®æ¢**
- âœ… åªåœ¨ CPU ä¸Šåšåºåˆ—ç½®æ¢ï¼ˆç¬¬ 76 è¡Œå’Œç¬¬ 90 è¡Œï¼‰

#### MLP çš„ç½®æ¢æ“ä½œï¼ˆä»…åœ¨ CPUï¼‰

**ç½®æ¢å‰** (ç¬¬ 74-78 è¡Œ):
```python
if prefill:
    # åœ¨ CPU ä¸Šåšåºåˆ—ç½®æ¢
    hidden_states = hidden_states[:, self.ff_pi_left]
    # å‘å› GPU
    hidden_states = hidden_states.to(orig_device)
```

**ç½®æ¢å** (ç¬¬ 87-91 è¡Œ):
```python
if prefill:
    # å›åˆ° CPUï¼Œæ¢å¤é¡ºåº
    hidden_states = hidden_states.to("cpu")
    hidden_states = hidden_states[:, self.ff_inv_pi_left]
    hidden_states = hidden_states.to(orig_device)
```

---

## ğŸ¯ å…³é”®å¯¹æ¯”

### Attention å±‚ vs MLP å±‚

| æ“ä½œ | Attention å±‚ | MLP å±‚ |
|-----|-------------|--------|
| **GPU è®¡ç®—** | âœ… åœ¨ç½®æ¢ç©ºé—´ | âŒ åœ¨åŸå§‹ç©ºé—´ |
| **ç½®æ¢ç±»å‹** | ç»´åº¦ç½®æ¢ (hidden_dim) | åºåˆ—ç½®æ¢ (seq_len) |
| **ç½®æ¢ä½ç½®** | GPU (ç¬¬ 236-238 è¡Œ) | CPU (ç¬¬ 76, 90 è¡Œ) |
| **é˜²å¾¡ç›®æ ‡** | Attention çŸ©é˜µ | MLP è¾“å…¥/è¾“å‡º |

---

## ğŸ›¡ï¸ é˜²å¾¡æœºåˆ¶ç†è§£

### Attention å±‚çš„é˜²å¾¡

**GPU ä¸Šçš„æ“ä½œè¢«ä¿æŠ¤**:
```python
# GPU ä¸Šè®¡ç®— (åœ¨ç½®æ¢ç©ºé—´)
attn_output = Attention(Q_permuted, K_permuted, V_permuted)
```

**æ”»å‡»è€…çœ‹åˆ°çš„**:
- GPU è®¡ç®—çš„ä¸­é—´ç»“æœæ˜¯ç½®æ¢åçš„
- æ³¨æ„åŠ›æƒé‡åœ¨ç½®æ¢ç©ºé—´
- éš¾ä»¥ç›´æ¥ç†è§£è¯­ä¹‰

### MLP å±‚çš„é˜²å¾¡

**GPU ä¸Šçš„æ“ä½œä¸è¢«ä¿æŠ¤**:
```python
# GPU ä¸Šè®¡ç®— (åœ¨åŸå§‹ç©ºé—´)
mlp_output = MLP(hidden_states)  # æ²¡æœ‰ç½®æ¢ï¼
```

**ä½†æ˜¯**:
- è¾“å…¥å‰åœ¨ CPU ä¸Šåšäº†åºåˆ—ç½®æ¢
- è¾“å‡ºååœ¨ CPU ä¸Šæ¢å¤åºåˆ—
- MLP æƒé‡çŸ©é˜µæœ¬èº«æ²¡æœ‰è¢«ç½®æ¢

---

## ğŸ¯ å¯¹æ”»å‡»çš„å½±å“

### 1. å¦‚æœæ”»å‡» Attention å±‚çš„è¾“å‡º

**éœ€è¦å¤„ç†**:
- âœ… åºåˆ—ç»´åº¦ç½®æ¢ (CPU)
- âœ… **Hidden ç»´åº¦ç½®æ¢ (GPU)** â­

**æ”»å‡»ç­–ç•¥**:
```python
dist_funct = "l1_sort_permuted"  # éœ€è¦åŒæ—¶å¤„ç† S å’Œ D
perm_type = "SD"
```

### 2. å¦‚æœæ”»å‡» MLP å±‚çš„è¾“å‡º

**éœ€è¦å¤„ç†**:
- âœ… åºåˆ—ç»´åº¦ç½®æ¢ (CPU)
- âŒ Hidden ç»´åº¦ç½®æ¢ (GPU) - **ä¸å­˜åœ¨ï¼**

**æ”»å‡»ç­–ç•¥**:
```python
dist_funct = "l1_permuted"  # åªéœ€å¤„ç†åºåˆ—ç½®æ¢
perm_type = "S"
```

---

## ğŸ”¬ ä¸ºä»€ä¹ˆ MLP ä¸åœ¨ GPU ä¸Šç½®æ¢ï¼Ÿ

### å¯èƒ½çš„åŸå› 

1. **æ€§èƒ½è€ƒè™‘**:
   - MLP çŸ©é˜µä¹˜æ³•å¾ˆå¤§
   - ç½®æ¢ä¼šå½±å“çŸ©é˜µä¹˜æ³•çš„æ€§èƒ½ä¼˜åŒ–

2. **é˜²å¾¡è®¾è®¡**:
   - åºåˆ—ç½®æ¢å·²ç»è¶³å¤Ÿï¼ˆæ‰“ä¹± token é¡ºåºï¼‰
   - Hidden ç»´åº¦ç½®æ¢å¯èƒ½å¯¹ MLP å½±å“ä¸å¤§

3. **å®ç°ç®€åŒ–**:
   - åªéœ€åœ¨ CPU ä¸Šåšç®€å•çš„ç½®æ¢
   - ä¸éœ€è¦ä¿®æ”¹ GPU ä¸Šçš„ MLP è®¡ç®—

---

## ğŸ“ å½“å‰æ”»å‡»é…ç½®çš„é—®é¢˜

### æˆ‘ä»¬çš„é…ç½®
```python
dist_funct = "l1_sort"   # åªå¤„ç†ç»´åº¦ç½®æ¢
perm_type = "D"          # åªæµ‹è¯•ç»´åº¦ç½®æ¢
```

### é—®é¢˜åˆ†æ

**å¦‚æœæ”»å‡»çš„æ˜¯ MLP å±‚è¾“å‡º**:
- âŒ MLP åœ¨ GPU ä¸Š**æ²¡æœ‰åšç»´åº¦ç½®æ¢**
- âŒ æˆ‘ä»¬å´åœ¨æµ‹è¯•ç»´åº¦ç½®æ¢æ”»å‡»
- âŒ ä¸åŒ¹é…ï¼

**æ­£ç¡®çš„é…ç½®åº”è¯¥æ˜¯**:
```python
# æ–¹æ¡ˆ 1: æµ‹è¯•æ— é˜²å¾¡ (MLP GPU æ“ä½œ)
dist_funct = "l1"
perm_type = "None"

# æ–¹æ¡ˆ 2: æµ‹è¯•åºåˆ—ç½®æ¢ (MLP CPU æ“ä½œ)
dist_funct = "l1_permuted"
perm_type = "S"

# æ–¹æ¡ˆ 3: æ”»å‡» Attention å±‚è¾“å‡º
dist_funct = "l1_sort_permuted"
perm_type = "SD"
```

---

## ğŸ¯ å»ºè®®çš„æ”»å‡»ç­–ç•¥

### ç­–ç•¥ 1: æ”»å‡» Attention å±‚çš„ GPU è®¡ç®—

**ç›®æ ‡**: Attention åœ¨ GPU ä¸Šçš„ä¸­é—´çŠ¶æ€

**é…ç½®**:
```python
dist_funct = "l1_sort"       # å¤„ç† hidden_dim ç½®æ¢
perm_type = "D"
```

**æˆ–è€…**:
```python
dist_funct = "l1_sort_permuted"  # å¤„ç† S + D
perm_type = "SD"
```

### ç­–ç•¥ 2: æ”»å‡» MLP å±‚çš„ GPU è®¡ç®—

**ç›®æ ‡**: MLP çš„è¾“å…¥/è¾“å‡ºï¼ˆGPU ä¸Šï¼‰

**é…ç½®**:
```python
dist_funct = "l1"            # æ— éœ€å¤„ç†ç»´åº¦ç½®æ¢
perm_type = "None"           # GPU ä¸Šæ— ç½®æ¢
```

**åŸå› **: MLP åœ¨ GPU ä¸Š**æ²¡æœ‰ç»´åº¦ç½®æ¢**ï¼

### ç­–ç•¥ 3: æ”»å‡»å®Œæ•´çš„å±‚è¾“å‡ºï¼ˆç»è¿‡ CPU å¤„ç†ï¼‰

**ç›®æ ‡**: å±‚çš„æœ€ç»ˆè¾“å‡ºï¼ˆç»è¿‡æ‰€æœ‰ç½®æ¢ï¼‰

**é…ç½®**:
```python
dist_funct = "l1_permuted"   # å¤„ç†åºåˆ—ç½®æ¢
perm_type = "S"
```

---

## âœ… æ€»ç»“

### SCX åœ¨ Prefill é˜¶æ®µ GPU ä¸Šçš„ä¿®æ”¹

1. **Attention å±‚**:
   - âœ… åœ¨ GPU ä¸Šå¯¹ Q/K/V åš **hidden_dim ç»´åº¦ç½®æ¢**
   - âœ… Attention è®¡ç®—åœ¨**ç½®æ¢ç©ºé—´**è¿›è¡Œ
   - ğŸ›¡ï¸ å¼ºé˜²å¾¡

2. **MLP å±‚**:
   - âŒ åœ¨ GPU ä¸Š**æ²¡æœ‰åšç½®æ¢**
   - âœ… åªåœ¨ CPU ä¸Šåš**åºåˆ—ç½®æ¢**
   - ğŸ›¡ï¸ å¼±é˜²å¾¡

### å¯¹æ”»å‡»çš„æŒ‡å¯¼

- æ”»å‡» Attention GPU ä¸­é—´çŠ¶æ€ â†’ éœ€è¦ `l1_sort` æˆ– `l1_sort_permuted`
- æ”»å‡» MLP GPU ä¸­é—´çŠ¶æ€ â†’ åªéœ€è¦ `l1` (æ— ç½®æ¢)
- æ”»å‡»å±‚çš„æœ€ç»ˆè¾“å‡º â†’ éœ€è¦ `l1_permuted` (åºåˆ—ç½®æ¢)

### å½“å‰é…ç½®çš„é€‚ç”¨æ€§

```python
dist_funct = "l1_sort"   # é€‚åˆæ”»å‡» Attention çš„ GPU è®¡ç®—
perm_type = "D"          # é€‚åˆæ”»å‡»æœ‰ç»´åº¦ç½®æ¢çš„éƒ¨åˆ†
```

**è¿™ä¸ªé…ç½®é€‚åˆæ”»å‡»**:
- âœ… Attention å±‚åœ¨ GPU ä¸Šçš„è®¡ç®—
- âŒ **ä¸é€‚åˆ** MLP å±‚ï¼ˆMLP åœ¨ GPU ä¸Šæ— ç»´åº¦ç½®æ¢ï¼‰

---

**ç»“è®º**: SCX çš„é˜²å¾¡ä¸»è¦åœ¨ **Attention å±‚çš„ GPU è®¡ç®—**ä¸Šï¼ŒMLP å±‚çš„ GPU è®¡ç®—ç›¸å¯¹è¾ƒå¼±ï¼


